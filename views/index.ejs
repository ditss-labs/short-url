<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASUMA Link - URL Shortener</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .floating-label {
            transform: translateY(-50%);
            transition: all 0.2s ease;
        }
        .form-input:focus + .floating-label,
        .form-input:not(:placeholder-shown) + .floating-label {
            transform: translateY(-140%);
            font-size: 0.75rem;
            color: #8b5cf6;
        }
        .tab-active {
            border-bottom: 3px solid #8b5cf6;
            color: #8b5cf6;
        }
        .animate-pulse { animation: pulse 2s infinite; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        .real-time-badge {
            animation: blink 1.5s infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-50 to-blue-50">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-6xl mx-auto">
            <div class="text-center mb-12">
                <div class="inline-flex items-center justify-center p-3 bg-gradient-to-r from-purple-600 to-blue-600 rounded-2xl shadow-xl mb-6">
                    <i class="fas fa-link text-4xl text-white"></i>
                </div>
                <h1 class="text-5xl font-bold text-gray-800 mb-3">ASUMA Link</h1>
                <p class="text-xl text-gray-600">Shorten, track, and analyze your links with advanced analytics</p>
                <div class="mt-4 inline-flex items-center space-x-2 text-sm text-purple-600 bg-purple-100 px-4 py-2 rounded-full">
                    <i class="fas fa-bolt"></i>
                    <span>Powered by Vercel Edge Network</span>
                    <i class="fas fa-globe"></i>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Main Form Section -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-2xl shadow-2xl overflow-hidden mb-8">
                        <div class="border-b border-gray-200">
                            <div class="flex">
                                <button id="basicTab" class="flex-1 py-4 text-center font-medium text-gray-700 tab-active">
                                    <i class="fas fa-bolt mr-2"></i>Basic
                                </button>
                                <button id="advancedTab" class="flex-1 py-4 text-center font-medium text-gray-600 hover:text-gray-900">
                                    <i class="fas fa-cogs mr-2"></i>Advanced
                                </button>
                            </div>
                        </div>
                        
                        <form id="shortenForm" class="p-8">
                            <div id="basicSection">
                                <div class="mb-8">
                                    <div class="relative">
                                        <input type="url" id="originalUrl" required
                                               placeholder=" "
                                               class="form-input w-full px-6 py-4 text-lg border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition duration-300">
                                        <label class="floating-label absolute left-6 top-1/2 text-gray-500 bg-white px-2">
                                            <i class="fas fa-link mr-2"></i>Enter your long URL
                                        </label>
                                    </div>
                                    <p class="mt-2 text-sm text-gray-500">Example: https://example.com/very-long-url</p>
                                </div>
                                
                                <div class="mb-8">
                                    <div class="relative">
                                        <input type="text" id="customId" 
                                               placeholder=" "
                                               pattern="[a-zA-Z0-9_-]{3,20}"
                                               class="form-input w-full px-6 py-4 text-lg border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition duration-300">
                                        <label class="floating-label absolute left-6 top-1/2 text-gray-500 bg-white px-2">
                                            <i class="fas fa-pen mr-2"></i>Custom alias (optional)
                                        </label>
                                    </div>
                                    <p class="mt-2 text-sm text-gray-500">Customize your short link: <%= APP_DOMAIN %>/<span id="customPreview" class="font-semibold text-purple-600">your-alias</span></p>
                                </div>
                            </div>
                            
                            <div id="advancedSection" class="hidden">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            <i class="fas fa-calendar-alt mr-2"></i>Expires After
                                        </label>
                                        <select id="expiresInDays" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                            <option value="1">24 Hours</option>
                                            <option value="7">1 Week</option>
                                            <option value="30" selected>30 Days</option>
                                            <option value="90">3 Months</option>
                                            <option value="365">1 Year</option>
                                            <option value="9999">Never</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            <i class="fas fa-tachometer-alt mr-2"></i>Max Clicks
                                        </label>
                                        <input type="number" id="maxClicks" min="1" max="1000000"
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                               placeholder="Unlimited">
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            <i class="fas fa-lock mr-2"></i>Password Protection
                                        </label>
                                        <input type="password" id="password"
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                               placeholder="Optional password">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            <i class="fas fa-clock mr-2"></i>Schedule Deletion
                                        </label>
                                        <input type="datetime-local" id="deleteAt"
                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="pt-6">
                                <button type="submit" id="shortenBtn"
                                        class="w-full py-4 px-6 bg-gradient-to-r from-purple-600 to-blue-600 text-white font-bold text-lg rounded-xl hover:from-purple-700 hover:to-blue-700 transform hover:-translate-y-1 transition duration-300 shadow-lg hover:shadow-xl flex items-center justify-center animate-pulse">
                                    <i class="fas fa-magic mr-3"></i>
                                    <span id="btnText">Shorten URL</span>
                                    <i class="fas fa-arrow-right ml-3"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <div id="result" class="bg-white rounded-2xl shadow-2xl p-8 mb-8 hidden animate-fade-in">
                        <div class="flex items-start mb-6">
                            <div class="p-3 bg-green-100 rounded-xl mr-4">
                                <i class="fas fa-check-circle text-3xl text-green-600"></i>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold text-gray-800">Your Short URL is Ready!</h3>
                                <p class="text-gray-600">Share this link anywhere</p>
                            </div>
                        </div>
                        
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Short URL:</label>
                                <div class="flex items-center">
                                    <input type="text" id="shortUrlOutput" readonly
                                           class="flex-1 px-6 py-4 text-lg border-2 border-gray-300 rounded-l-xl bg-gray-50 font-mono">
                                    <button onclick="copyToClipboard('shortUrlOutput')"
                                            class="px-8 py-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-r-xl hover:from-green-600 hover:to-emerald-700 transition flex items-center">
                                        <i class="fas fa-copy mr-2"></i>Copy
                                    </button>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="bg-gray-50 p-4 rounded-xl">
                                    <label class="block text-sm font-medium text-gray-600 mb-1">Clicks</label>
                                    <p id="clicksCount" class="text-2xl font-bold text-purple-600">0</p>
                                    <p class="text-xs text-gray-500 real-time-badge" id="realtimeBadge">
                                        <i class="fas fa-circle text-green-500 mr-1"></i>Real-time
                                    </p>
                                </div>
                                <div class="bg-gray-50 p-4 rounded-xl">
                                    <label class="block text-sm font-medium text-gray-600 mb-1">Status</label>
                                    <p id="urlStatus" class="text-lg font-semibold text-green-600">Active</p>
                                    <p id="urlFeatures" class="text-xs text-gray-500"></p>
                                </div>
                                <div class="bg-gray-50 p-4 rounded-xl">
                                    <label class="block text-sm font-medium text-gray-600 mb-1">Expires</label>
                                    <p id="expiresDate" class="text-lg font-semibold text-gray-800"></p>
                                </div>
                            </div>
                            
                            <div class="flex flex-wrap gap-4 pt-4">
                                <a href="#" id="visitLink" target="_blank"
                                   class="flex-1 min-w-[200px] py-3 px-6 bg-blue-500 text-white rounded-xl hover:bg-blue-600 transition text-center flex items-center justify-center">
                                    <i class="fas fa-external-link-alt mr-2"></i>Visit Link
                                </a>
                                <a href="#" id="qrLink" target="_blank"
                                   class="flex-1 min-w-[200px] py-3 px-6 bg-purple-500 text-white rounded-xl hover:bg-purple-600 transition text-center flex items-center justify-center">
                                    <i class="fas fa-qrcode mr-2"></i>QR Code
                                </a>
                                <a href="#" id="statsLink" target="_blank"
                                   class="flex-1 min-w-[200px] py-3 px-6 bg-green-500 text-white rounded-xl hover:bg-green-600 transition text-center flex items-center justify-center">
                                    <i class="fas fa-chart-bar mr-2"></i>Analytics
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- History Sidebar -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-2xl shadow-2xl p-6 h-full">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-xl font-bold text-gray-800">
                                <i class="fas fa-history mr-2"></i>Recent Links
                            </h2>
                            <button onclick="clearHistory()" class="text-sm text-gray-500 hover:text-gray-700">
                                <i class="fas fa-trash mr-1"></i>Clear
                            </button>
                        </div>
                        
                        <div id="historyList" class="space-y-4 max-h-[500px] overflow-y-auto pr-2">
                            <!-- History items will be loaded here -->
                        </div>
                        
                        <div id="emptyHistory" class="text-center py-8">
                            <i class="fas fa-inbox text-4xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">No links created yet</p>
                            <p class="text-sm text-gray-400 mt-1">Your created links will appear here</p>
                        </div>
                        
                        <div class="mt-6 pt-6 border-t border-gray-200">
                            <div class="flex items-center justify-between text-sm">
                                <div class="text-gray-600">
                                    <i class="fas fa-database mr-1"></i>
                                    <span id="historyCount">0</span> links saved
                                </div>
                                <div class="text-gray-600">
                                    <i class="fas fa-sync-alt mr-1"></i>
                                    Auto-save: <span class="text-green-600">ON</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Real-time Stats Card -->
                    <div class="bg-white rounded-2xl shadow-2xl p-6 mt-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-chart-line mr-2"></i>Real-time Stats
                        </h2>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <span class="text-gray-600">Active Links</span>
                                <span id="activeLinks" class="font-bold text-purple-600">0</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-600">Total Clicks</span>
                                <span id="totalClicks" class="font-bold text-blue-600">0</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-600">Protected Links</span>
                                <span id="protectedLinks" class="font-bold text-green-600">0</span>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-100">
                            <p class="text-xs text-gray-500">
                                <i class="fas fa-info-circle mr-1"></i>
                                Stats update every 10 seconds
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // LocalStorage History Management
        const HISTORY_KEY = 'asuma_link_history';
        const MAX_HISTORY = 50;
        
        function getHistory() {
            try {
                const history = localStorage.getItem(HISTORY_KEY);
                return history ? JSON.parse(history) : [];
            } catch (e) {
                return [];
            }
        }
        
        function saveToHistory(item) {
            try {
                let history = getHistory();
                
                // Remove duplicate if exists
                history = history.filter(h => h.shortId !== item.shortId);
                
                // Add to beginning
                history.unshift(item);
                
                // Limit history size
                if (history.length > MAX_HISTORY) {
                    history = history.slice(0, MAX_HISTORY);
                }
                
                localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
                renderHistory();
                updateStats();
                
                return true;
            } catch (e) {
                console.error('Error saving to history:', e);
                return false;
            }
        }
        
        function clearHistory() {
            if (confirm('Are you sure you want to clear all history?')) {
                localStorage.removeItem(HISTORY_KEY);
                renderHistory();
                updateStats();
            }
        }
        
        function renderHistory() {
            const history = getHistory();
            const historyList = document.getElementById('historyList');
            const emptyHistory = document.getElementById('emptyHistory');
            const historyCount = document.getElementById('historyCount');
            
            historyCount.textContent = history.length;
            
            if (history.length === 0) {
                historyList.innerHTML = '';
                emptyHistory.classList.remove('hidden');
                return;
            }
            
            emptyHistory.classList.add('hidden');
            
            historyList.innerHTML = history.map(item => `
                <div class="border border-gray-200 rounded-xl p-4 hover:bg-gray-50 transition">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center mb-1">
                                <i class="fas fa-link text-gray-400 text-sm mr-2"></i>
                                <a href="${item.shortUrl}" target="_blank" 
                                   class="font-medium text-purple-600 hover:text-purple-800 truncate">
                                    ${item.shortUrl.replace('https://', '')}
                                </a>
                                <button onclick="copyToClipboardText('${item.shortUrl}')" 
                                        class="ml-2 text-gray-400 hover:text-gray-600">
                                    <i class="fas fa-copy text-xs"></i>
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 truncate" title="${item.originalUrl}">
                                ${item.originalUrl.length > 40 ? item.originalUrl.substring(0, 40) + '...' : item.originalUrl}
                            </p>
                        </div>
                    </div>
                    <div class="flex justify-between items-center mt-3">
                        <div class="flex space-x-2">
                            ${item.requiresPassword ? 
                                '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full"><i class="fas fa-lock mr-1"></i>Password</span>' : ''}
                            ${item.maxClicks ? 
                                `<span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full"><i class="fas fa-tachometer-alt mr-1"></i>Max ${item.maxClicks}</span>` : ''}
                        </div>
                        <span class="text-xs text-gray-500">
                            ${new Date(item.createdAt).toLocaleDateString()}
                        </span>
                    </div>
                    <div class="flex space-x-2 mt-3">
                        <a href="${item.shortUrl}" target="_blank"
                           class="flex-1 py-1 px-2 bg-blue-50 text-blue-700 text-xs rounded-lg hover:bg-blue-100 text-center">
                            <i class="fas fa-external-link-alt mr-1"></i>Visit
                        </a>
                        <a href="${item.shortUrl.replace('https://', '/').split('/').pop()}/stats"
                           class="flex-1 py-1 px-2 bg-green-50 text-green-700 text-xs rounded-lg hover:bg-green-100 text-center">
                            <i class="fas fa-chart-bar mr-1"></i>Stats
                        </a>
                        <a href="${item.shortUrl.replace('https://', '/').split('/').pop()}/qr"
                           class="flex-1 py-1 px-2 bg-purple-50 text-purple-700 text-xs rounded-lg hover:bg-purple-100 text-center">
                            <i class="fas fa-qrcode mr-1"></i>QR
                        </a>
                    </div>
                </div>
            `).join('');
        }
        
        function updateStats() {
            const history = getHistory();
            const activeLinks = history.length;
            const totalClicks = history.reduce((sum, item) => sum + (item.clicks || 0), 0);
            const protectedLinks = history.filter(item => item.requiresPassword).length;
            
            document.getElementById('activeLinks').textContent = activeLinks;
            document.getElementById('totalClicks').textContent = totalClicks;
            document.getElementById('protectedLinks').textContent = protectedLinks;
        }
        
        // Tab switching
        document.getElementById('basicTab').addEventListener('click', () => {
            document.getElementById('basicTab').classList.add('tab-active');
            document.getElementById('advancedTab').classList.remove('tab-active');
            document.getElementById('basicSection').classList.remove('hidden');
            document.getElementById('advancedSection').classList.add('hidden');
        });
        
        document.getElementById('advancedTab').addEventListener('click', () => {
            document.getElementById('advancedTab').classList.add('tab-active');
            document.getElementById('basicTab').classList.remove('tab-active');
            document.getElementById('advancedSection').classList.remove('hidden');
            document.getElementById('basicSection').classList.add('hidden');
        });
        
        document.getElementById('customId').addEventListener('input', (e) => {
            document.getElementById('customPreview').textContent = e.target.value || 'your-alias';
        });
        
        // Form submission
        document.getElementById('shortenForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const originalUrl = document.getElementById('originalUrl').value;
            const customId = document.getElementById('customId').value;
            const expiresInDays = document.getElementById('expiresInDays').value;
            const password = document.getElementById('password').value;
            const maxClicks = document.getElementById('maxClicks').value;
            const deleteAt = document.getElementById('deleteAt').value;
            const shortenBtn = document.getElementById('shortenBtn');
            
            document.getElementById('result').classList.add('hidden');
            
            shortenBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
            shortenBtn.disabled = true;
            
            try {
                const response = await fetch('/api/shorten', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        originalUrl, 
                        customId, 
                        expiresInDays, 
                        password, 
                        maxClicks,
                        deleteAt 
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('shortUrlOutput').value = data.shortUrl;
                    document.getElementById('clicksCount').textContent = '0';
                    document.getElementById('expiresDate').textContent = 
                        new Date(data.expiresAt).toLocaleDateString();
                    document.getElementById('visitLink').href = data.shortUrl;
                    document.getElementById('qrLink').href = data.qrCode;
                    document.getElementById('statsLink').href = `/${data.shortId}/stats`;
                    
                    // Set status and features
                    let status = 'Active';
                    let statusColor = 'text-green-600';
                    let features = [];
                    
                    if (data.requiresPassword) {
                        features.push('Password Protected');
                    }
                    if (data.maxClicks) {
                        features.push(`Max ${data.maxClicks} clicks`);
                        status = `Active (${data.maxClicks} clicks max)`;
                    }
                    
                    document.getElementById('urlStatus').textContent = status;
                    document.getElementById('urlStatus').className = `text-lg font-semibold ${statusColor}`;
                    document.getElementById('urlFeatures').textContent = features.join(' â€¢ ');
                    
                    document.getElementById('result').classList.remove('hidden');
                    document.getElementById('result').scrollIntoView({ behavior: 'smooth' });
                    
                    // Save to history
                    if (data.historyItem) {
                        saveToHistory(data.historyItem);
                    } else {
                        saveToHistory({
                            shortUrl: data.shortUrl,
                            originalUrl: data.originalUrl,
                            shortId: data.shortId,
                            createdAt: new Date().toISOString(),
                            requiresPassword: data.requiresPassword || false,
                            maxClicks: data.maxClicks || null
                        });
                    }
                    
                    // Start real-time updates for this link
                    startRealTimeUpdates(data.shortId);
                } else {
                    alert(`Error: ${data.error}`);
                }
            } catch (error) {
                alert('Network error. Please try again.');
            } finally {
                shortenBtn.innerHTML = '<i class="fas fa-magic mr-3"></i><span id="btnText">Shorten URL</span><i class="fas fa-arrow-right ml-3"></i>';
                shortenBtn.disabled = false;
            }
        });
        
        // Real-time updates
        const realTimeIntervals = {};
        
        function startRealTimeUpdates(shortId) {
            if (realTimeIntervals[shortId]) return;
            
            realTimeIntervals[shortId] = setInterval(async () => {
                try {
                    const response = await fetch(`/api/realtime/${shortId}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        document.getElementById('clicksCount').textContent = data.data.clicks;
                        
                        // Update badge for recent activity
                        if (data.data.recentClicks > 0) {
                            const badge = document.getElementById('realtimeBadge');
                            badge.innerHTML = `<i class="fas fa-bolt text-yellow-500 mr-1"></i>${data.data.recentClicks} clicks in 5m`;
                            badge.className = 'text-xs text-yellow-600 font-medium';
                        }
                    }
                } catch (error) {
                    console.log('Real-time update error:', error);
                }
            }, 10000); // Update every 10 seconds
        }
        
        // Utility functions
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            element.select();
            element.setSelectionRange(0, 99999);
            document.execCommand('copy');
            
            const button = event.target.closest('button');
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check mr-2"></i>Copied!';
            button.classList.remove('from-green-500', 'to-emerald-600');
            button.classList.add('from-emerald-500', 'to-green-600');
            
            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.classList.remove('from-emerald-500', 'to-green-600');
                button.classList.add('from-green-500', 'to-emerald-600');
            }, 2000);
        }
        
        function copyToClipboardText(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('URL copied to clipboard!');
            });
        }
        
        // Set minimum datetime for schedule deletion
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('deleteAt').min = now.toISOString().slice(0, 16);
        
        // Load history on page load
        document.addEventListener('DOMContentLoaded', () => {
            renderHistory();
            updateStats();
            
            // Auto-update stats every 30 seconds
            setInterval(updateStats, 30000);
        });
    </script>
</body>
</html>
